<!DOCTYPE html>
<html lang="en,default">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Today I’d like to share my first attempt at creating a blog post.
In this post I’ll try to give a starting point for using Castle Dynamic Proxy interc">
    

    <!--Author-->
    
        <meta name="author" content="Maarten De Raedemaeker">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Using type interceptors with Autofac"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Maarten De Raedemaeker"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Using type interceptors with Autofac - Maarten De Raedemaeker</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-97880416-1', 'auto');
        ga('send', 'pageview');

    </script>



    <!-- favicon -->
    
    <link rel="icon" href="/images/theming/favicon.png">
    
	
</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Maarten De Raedemaeker</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/maartenderaedemaeker">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/images/theming/background.png')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Using type interceptors with Autofac</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                            Posted by Maarten De Raedemaeker on
                        
                        
                            2017-07-23
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/C/">#C#</a> <a href="/tags/NET/">#.NET</a> <a href="/tags/AutoFac/">#AutoFac</a> <a href="/tags/DynamicProxy/">#DynamicProxy</a> <a href="/tags/AOP/">#AOP</a> <a href="/tags/Interceptors/">#Interceptors</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                        

<a href="/categories/Software-development/">Software development</a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <hr>
<p>Today I’d like to share my first attempt at creating a blog post.</p>
<p>In this post I’ll try to give a starting point for using Castle Dynamic Proxy interceptors using AutoFac, though most of it also applies to Castle Windsor.</p>
<p>I’ll try to cover how it can be helpful using examples.</p>
<p>If you prefer just to get some sample code instead of reading a blog post, I’ve added a very basic example linked below (I purposely tried to keep it simple):</p>
<p><a href="https://github.com/maartenderaedemaeker/Simplistic-Autofac-Interceptors-POC/tree/master/AutofacInterceptorPoc" target="_blank" rel="noopener">Sample code</a></p>
<hr>
<h1 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h1><ul>
<li>Cross cutting concerns</li>
<li>Aspect oriented programming</li>
<li>Proxy pattern</li>
<li>Castle Dynamic Proxy</li>
<li>AutoFac: interceptors</li>
<li>Conclusion</li>
</ul>
<hr>
<h3 id="Cross-cutting-concerns"><a href="#Cross-cutting-concerns" class="headerlink" title="Cross cutting concerns"></a>Cross cutting concerns</h3><p>To get an idea of what cross cutting concerns are, take a look at the following code sample.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public void DoSomething()</span><br><span class="line">&#123;</span><br><span class="line">	using(SomeTimeMeasuringHelper.Measure(() =&gt; &#123;</span><br><span class="line">		Log(&quot;Entered DoSomething&quot;);</span><br><span class="line">		try &#123;</span><br><span class="line">			using(var transaction = Helper.StartTransaction())</span><br><span class="line">			&#123;</span><br><span class="line">				Retry(() =&gt; &#123;</span><br><span class="line">					/* MAYBE WE CAN PUT BUSINESS LOGIC HERE? */ </span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;				</span><br><span class="line">		&#125; </span><br><span class="line">        catch(Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">             LogError(e); </span><br><span class="line">             throw;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">&#125; // try repeat exactly the same for next method</span><br><span class="line">///oh, and update everywhere if this changes</span><br></pre></td></tr></table></figure></p>
<p>As you can see, we have quite a bit of code here, and none of it is actually doing any business logic.</p>
<hr>
<h3 id="Cross-cutting-concerns-what-are-they"><a href="#Cross-cutting-concerns-what-are-they" class="headerlink" title="Cross cutting concerns: what are they?"></a>Cross cutting concerns: what are they?</h3><p>According to wikipedia:</p>
<blockquote>
<p>In aspect-oriented software development, cross-cutting concerns are aspects of a program that affect other concerns. These concerns often cannot be cleanly decomposed from the rest of the system in both the design and implementation, and can result in either scattering (code duplication), tangling (significant dependencies between systems), or both.<br><a href="https://en.wikipedia.org/wiki/Cross-cutting_concern" target="_blank" rel="noopener">Source: wikipedia</a></p>
</blockquote>
<p>So, what does that mean? Let’s look back to the previous sample.</p>
<hr>
<h3 id="Cross-cutting-concerns-example"><a href="#Cross-cutting-concerns-example" class="headerlink" title="Cross cutting concerns: example"></a>Cross cutting concerns: example</h3><p><img src="/images/2017/07/23/crosscuttingconcerns.png" alt="Cross cutting concerns example"></p>
<hr>
<h3 id="Aspect-Oriented-Programming"><a href="#Aspect-Oriented-Programming" class="headerlink" title="Aspect Oriented Programming"></a>Aspect Oriented Programming</h3><p>So, where does the <em>Cross cutting concern</em> idea come from?<br>Turns out, it is <a href="https://en.wikipedia.org/wiki/Aspect-oriented_software_development" target="_blank" rel="noopener">Aspect Oriented Programming</a>.</p>
<blockquote>
<p>Aspect-oriented software development focuses on the identification, specification and representation of cross-cutting concerns and their modularization into separate functional units as well as their automated composition into a working system. (Source: wikipedia)</p>
</blockquote>
<p>Right, Aspect Oriented Programming should let us be able to move all these things out of our business code, awesome! But how could we implement this in .NET?</p>
<p>Turns out, there are multiple ways of doing this.</p>
<ul>
<li>One way is to use code weaving (for example: PostSharp). The tool will make sure the aspects (for example logging) will be used by modifying the outputted intermediate language.</li>
<li>Another way (the way I’m discussing in this post) is to dynamically generate proxy classes. We’ll use the .NET library Castle Dynamic Proxy.</li>
</ul>
<hr>
<h3 id="Proxy-pattern"><a href="#Proxy-pattern" class="headerlink" title="Proxy pattern"></a>Proxy pattern</h3><p>This brings us back to a quick refresher of the proxy pattern, applied to the example.<br>The real <em>Something</em> class and the <em>DoSomething</em> method will not be invoked directly. Instead, another class will do some logic, then (optionally) delegate to the real implementation.Since they both implement the same interface, and the client is calling the object using the interface, the client does not have to know that it is talking to a proxy instead to the original class.</p>
<p><img src="/images/2017/07/23/proxy-pattern.png" alt="Proxy pattern"></p>
<p>So, this is all splendid, but we don’t really want to manually create a proxy class for each type we want to intercept right?</p>
<hr>
<h3 id="Castle-Dynamic-Proxy-to-the-rescue"><a href="#Castle-Dynamic-Proxy-to-the-rescue" class="headerlink" title="Castle Dynamic Proxy to the rescue"></a>Castle Dynamic Proxy to the rescue</h3><p>So what is Castle Dynamic proxy?<br>Well, it is a library that allows us to solve the issue of generating proxy classes.</p>
<ul>
<li>It generates dynamic proxy classes on the fly</li>
<li>It allows us to be able to intercept extend behaviour of virtual methods and methods exposed by the interface.</li>
</ul>
<p>Why the interface or virtual limitation, you might ask?<br>Castle Dynamic Proxy uses the proxy pattern by using inheritance (just like the ProxySomething class in the previous image).</p>
<hr>
<h3 id="Castle-dynamic-proxy-how"><a href="#Castle-dynamic-proxy-how" class="headerlink" title="Castle dynamic proxy: how?"></a>Castle dynamic proxy: how?</h3><p>We can write an AutoFac interceptor by implementing the Castle Dynamic Proxy IInterceptor interface.<br>The interface has one method: intercept, with one argument of the type IInvocation.<br>That object contains information about the invocation that is currently intercepted.<br>By calling the Proceed method, the wrapped invocation is called.</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src="/images/2017/07/23/interceptor-example.png" alt="Interceptor example"></h2><h3 id="AutoFac-using-interceptors"><a href="#AutoFac-using-interceptors" class="headerlink" title="AutoFac: using interceptors"></a>AutoFac: using interceptors</h3><p>To be able to use interceptors in AutoFac, you need to install the <em>Autofac.Extras.DynamicProxy</em> package (for more information: <a href="http://docs.autofac.org/en/latest/advanced/interceptors.html" target="_blank" rel="noopener">take a look at the AutoFac docs</a>.<br>In your AutoFac container setup you can configure interception. AutoFac will wrap the returned instance with a dynamic proxy.</p>
<p>So, how do we register the interceptor in our container building logic?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">builder</span><br><span class="line">    .RegisterType&lt;ConsoleLoggingInterceptor&gt;</span><br><span class="line">    .As&lt;ConsoleLoggingInterceptor&gt;();</span><br><span class="line"></span><br><span class="line">builder</span><br><span class="line">    .RegisterType&lt;ValuesRepository&gt;()</span><br><span class="line">    .As&lt;IValuesRepository&gt;()</span><br><span class="line">    .EnableInterfaceInterceptors() </span><br><span class="line">    // or EnableClassInterceptors() to enable interceptors for virtual members</span><br><span class="line">    .InterceptedBy(typeof(ConsoleLoggingInterceptor));</span><br><span class="line">    // TODO: maybe add more interceptors</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>So when we look at the changes to our code, we can clearly see the difference.<br>Before adding the interceptors our code looked like:</p>
<p><img src="/images/2017/07/23/crosscuttingconcerns.png" alt="Cross cutting concerns example"></p>
<p>When we use interceptors it would look something like this:</p>
<p><img src="/images/2017/07/23/crosscuttingconcerns-intercepted.png" alt="Cross cutting concerns example with interceptors"></p>
<p>So what happens if we chain these interceptors?<br>Take a look at the image below:</p>
<p><img src="/images/2017/07/23/InterceptorDiagram.png" alt="Cross cutting concerns interceptor flow"></p>
<p>Using interceptors does have a (minor) downside.<br>It becomes a little bit harder to reason about your code, because of the increased complexity. (You do not see all you code at the same spot).<br>I would argue that the benefits of moving the cross cutting concerns away from the business logic makes it very worthwhile though.</p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    
    <hr />
    <h3>Comments:</h3>
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>



                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/maartenderaedemaeker" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="https://www.linkedin.com/in/maartenderaedemaeker/" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2018 Maarten De Raedemaeker<br></p>
               </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'maarten-de-raedemaeker';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>

</html>